{% extends "index.html" %}

{% block title %}Piano Tour - Interactive Drums Studio{% endblock %}

{% block head %}
<!-- Add drum-specific CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/drumstyles.css') }}" />
{% endblock %}

{% block player %}
<!-- Replace piano player with drum player -->
<button id="play-drums-score-btn" class="btn btn--primary playback-controls__button">
  ▶ Play
</button>
{% endblock %}

{% block after %}
<!-- Add drum score viewer and controls after the piano instrument -->

<!-- Drum Score Viewer -->
<section class="score-viewer">
  <div class="drums-score-viewer__container" id="drums-score-wrap">
    <div class="drums-score-viewer__content" id="drums-score"></div>
  </div>
</section>

<!-- Drum Controls -->
<div class="drum-controls">
  <div class="drum-controls__section">
    <h4 class="drum-controls__section-title">Drum Instruments & Duration</h4>
    <div class="drum-switches-container" id="drumButtonContainer" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5em;">
      
      <!-- Drum Instruments -->
      <div class="drum-step-button" data-drum="box-kick">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Kick</span>
      </div>

      <div class="drum-step-button" data-drum="snare">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Snare</span>
      </div>
      <div class="drum-step-button" data-drum="tom-low">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Low Tom</span>
      </div>
      <div class="drum-step-button" data-drum="tom-mid">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Mid Tom</span>
      </div>
      <div class="drum-step-button" data-drum="tom-high">
        <div class="indicator"></div>
        <span class="drum-step-button-label">High Tom</span>
      </div>

      <div class="drum-step-button" data-drum="sidestick">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Stick</span>
      </div>
      <div class="drum-step-button" data-drum="hihat-closed">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Closed Hat</span>
      </div>
      <div class="drum-step-button" data-drum="hihat-open">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Open Hat</span>
      </div>
      <div class="drum-step-button" data-drum="crash">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Crash</span>
      </div>
      <div class="drum-step-button" data-drum="ride">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Ride</span>
      </div>
      <div class="drum-step-button" data-drum="bongo-low">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Low Bongo</span>
      </div>
      <div class="drum-step-button" data-drum="bongo-high">
        <div class="indicator"></div>
        <span class="drum-step-button-label">High Bongo</span>
      </div>
      <div class="drum-step-button" data-drum="clap">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Clap</span>
      </div>
      <div class="drum-step-button" data-drum="cowbell">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Cowbell</span>
      </div>
      <div class="drum-step-button" data-drum="rest">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Rest</span>
      </div>

      <!-- Duration Buttons -->
      <div class="drum-step-button" data-duration="16" id="drum-sixteenth-btn">
        <div class="indicator"></div>
        <span class="drum-step-button-label">16th</span>
      </div>
      <div class="drum-step-button" data-duration="8" id="drum-eighth-btn">
        <div class="indicator"></div>
        <span class="drum-step-button-label">8th</span>
      </div>
      <div class="drum-step-button" data-duration="q" id="drum-quarter-btn">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Quarter</span>
      </div>
      <div class="drum-step-button" data-duration="h" id="drum-half-btn">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Half</span>
      </div>
      <div class="drum-step-button" data-duration="w" id="drum-whole-btn">
        <div class="indicator"></div>
        <span class="drum-step-button-label">Whole</span>
      </div>
      
    </div>
    {% include 'partials/_drumGrid.html' %}
  </div>
</div>
{% endblock %}

{% block toggles %}
{% include 'partials/_toggles.html' %}
{% endblock %}

{% block scripts %}
<script type="module">
  console.log("Drums page script execution started.");

  // --- PIANO IMPORTS (from base template) ---
  import {
    initializeInstrumentUI,
    handleToggleLabelsChange,
    handleModeCycleClick,
  } from '{{ url_for("static", filename="js/instrument/instrumentHelpers.js") }}';
  import {
    getMeasures,
    resetScore,
    processAndSyncScore,
    undoLastWrite,
  } from '{{ url_for("static", filename="js/score/scoreWriter.js") }}';
  import {
    drawAll,
    setKeySignature,
  } from '{{ url_for("static", filename="js/score/scoreRenderer.js") }}';
  import { initializeFileHandlers } from '{{ url_for("static", filename="js/utils/ioHelpers.js") }}';
  import {
    handleChordDisplayToggle,
    handleKeySignatureClick,
    updateUI,
  } from '{{ url_for("static", filename="js/ui/uiHelpers.js") }}';
  import { pianoState } from '{{ url_for("static", filename="js/core/appState.js") }}';
  import { initializePlayer } from '{{ url_for("static", filename="js/score/scorePlayback.js") }}';
  import {
    initMidi,
    setMidiCallbacks,
    handleMidiNoteOn,
    handleMidiNoteOff,
  } from '{{ url_for("static", filename="js/instrument/midi-controller.js") }}';
  import audioManager from '{{ url_for("static", filename="js/core/audioManager.js") }}';

  // --- DRUM IMPORTS ---
  import { drumsState } from '{{ url_for("static", filename="js/core/appState.js") }}';
  import {
    getDrumMeasures,
    AUTOSAVE_KEY,
    resetDrumScore,
    processAndSyncScore as processAndSyncDrumScore,
    undoLastWrite as undoDrumLastWrite,
  } from '{{ url_for("static", filename="js/drums/drumsScoreWriter.js") }}';
  // ← REPLACE OLD IMPORT WITH NEW UNIVERSAL RENDERER
  import { UniversalMusicRenderer } from '{{ url_for("static", filename="js/classes/UniversalMusicRenderer.js") }}';
  import {
    initializeDrumAudioModule,
    handleDrumPlayback,
  } from '{{ url_for("static", filename="js/drums/drumAudio.js") }}';
  import { initializeDrumGrid } from '{{ url_for("static", filename="js/drums/drumGrid.js") }}';
  import { addBasicKeyboardListeners } from "{{ url_for('static', filename='js/ui/listenerManager.js') }}";

  // ← ADD: Create the drum renderer instance
  let drumRenderer = null;

  // ← ADD: Initialize drum renderer
  function initializeDrumRenderer() {
    drumRenderer = new UniversalMusicRenderer('drums-score', {
      instrumentType: 'drums',
      disableScrolling: false,
      timeSignature: drumsState.timeSignature,
      tempo: drumsState.tempo,
      keySignature: drumsState.keySignature || 'C'
    });
    console.log('🥁 Drum renderer initialized with 3 measures per system, scrolling disabled');
  }

  
  function renderDrums(measuresData = null) {
  if (!drumRenderer) {
    initializeDrumRenderer();
  }

  const measures = measuresData || getDrumMeasures();
  
  // Debug: Log the measures data
  console.log('🔍 Drum measures data:', JSON.stringify(measures, null, 2));
  
  // Update renderer settings with current state
  drumRenderer.timeSignature = drumsState.timeSignature;
  drumRenderer.tempo = drumsState.tempo;
  drumRenderer.keySignature = drumsState.keySignature || 'C';
  
  try {
    drumRenderer.render(measures);
    console.log('🥁 Drums rendered successfully using UniversalMusicRenderer');
  } catch (error) {
    console.error('🥁 Error rendering drums:', error);
  }
}

  // Set instrument type
  const templateInstrument = "{{ instrument }}" || "piano";
  pianoState.instrument = templateInstrument;
  console.log("Set instrument to:", templateInstrument);

// Wait for base initialization to complete
document.addEventListener("pianoTourBaseReady", () => {
  console.log("🥁 Base ready, initializing drum-specific components...");
  
  // Initialize drum renderer
  initializeDrumRenderer();
  
  // Initialize drum-specific modules
  initializeDrumAudioModule();
  initializeDrumGrid();
  addBasicKeyboardListeners();

  // Add drum-specific control buttons to the existing controls
  addDrumControlButtons();
  
  document.querySelectorAll(".drum-step-button, .drum-step-label").forEach((button) => {
    button.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      // Determine if it's a drum instrument or a duration button
      const drumType = this.dataset.drum;
      const durationType = this.dataset.duration;

      if (drumType) {
        console.log(`Drum button clicked: ${drumType}`);
        document.dispatchEvent(
          new CustomEvent("drumInstrumentSelected", {
            detail: drumType,
          })
        );
      } else if (durationType) {
        // Toggle the 'active' class for visual feedback for duration buttons only
        this.classList.toggle("active");
        console.log(`Duration button clicked: ${durationType}`);
        // Also, ensure only one duration button is active at a time.
        document
          .querySelectorAll(".drum-step-button[data-duration]")
          .forEach((durBtn) => {
            if (durBtn !== this) {
              durBtn.classList.remove("active");
            }
          });
        document.dispatchEvent(
          new CustomEvent("drumDurationSelected", {
            detail: durationType,
          })
        );
      }
    });
  });

  // Set initial active state for a duration button (e.g., Quarter)
  const initialDurationButton = document.querySelector(
    '.drum-step-button[data-duration="q"]'
  );
  if (initialDurationButton) {
    initialDurationButton.classList.add("active");
  }
  
  // Initialize drum score loading
  setTimeout(() => {
    loadDrumScoreFromStorage();
  }, 100);
});

  // Override some base template behaviors for drums
  function addDrumControlButtons() {
    // Find the controls button row and add drum-specific buttons
    const controlsRow = document.querySelector('.controls-button-row');
    if (controlsRow) {
      
      // Update the Clear Score button text
      const clearScoreBtn = document.getElementById('clearScoreBtn');
      if (clearScoreBtn) {
        clearScoreBtn.textContent = 'Clear Piano Score';
      }

      // Update the Undo button text  
      const undoBtn = document.getElementById('undo-btn');
      if (undoBtn) {
        undoBtn.textContent = 'Undo Piano';
      }

      // Add drum-specific buttons
      const drumButtons = `
        <button id="clear-drum-score-btn" class="btn btn--danger">Clear Drum Score</button>
        <button id="undo-drum-btn" class="btn btn--danger">Undo Drum</button>
      `;
      
      // Insert after the undo button
      if (undoBtn) {
        undoBtn.insertAdjacentHTML('afterend', drumButtons);
      }

      // Add event listeners for new buttons
      document.getElementById('clear-drum-score-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        resetDrumScore();
        console.log('🥁 Drum score cleared');
      });

      document.getElementById('undo-drum-btn')?.addEventListener('click', (e) => {
        e.preventDefault(); 
        undoDrumLastWrite();
        console.log('🥁 Drum undo performed');
      });
    }
  }

  // ← UPDATED: Load drum score from localStorage using new renderer
  async function loadDrumScoreFromStorage() {
    const savedDrumScoreJSON = localStorage.getItem(AUTOSAVE_KEY);
    if (!savedDrumScoreJSON) {
      console.log("📝 No saved drum score found");
      // Initialize with empty score using new renderer
      try {
        renderDrums([]);
      } catch (e) {
        console.error("Initial drum render error:", e);
      }
      return;
    }

    try {
      console.log("🔄 Loading saved drum score...");
      const savedData = JSON.parse(savedDrumScoreJSON);
      const measures = Array.isArray(savedData) ? savedData : savedData.measures;
      
      if (processAndSyncDrumScore(measures)) {
        renderDrums(getDrumMeasures());
        console.log("✅ Drum score loaded successfully");
      } else {
        localStorage.removeItem(AUTOSAVE_KEY);
        console.log("⚠️ Invalid drum score data, cleared");
        renderDrums([]);
      }
    } catch (e) {
      console.error("❌ Failed to load drum score:", e);
      localStorage.removeItem(AUTOSAVE_KEY);
      renderDrums([]);
    }
  }

  // ← UPDATED: Override the resize handler to use new renderer
  let drumResizeTimeout;
  window.addEventListener("resize", () => {
    clearTimeout(drumResizeTimeout);
    drumResizeTimeout = setTimeout(() => {
      console.log("📏 Handling resize for drums...");
      renderDrums(getDrumMeasures());
    }, 150);
  });

</script>
{% endblock %}